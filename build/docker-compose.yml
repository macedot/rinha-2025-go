name: rinha-2025

x-api_template:
  #image: docker.io/macedot/rinha-2025:latest
  &api_template
  build:
    context: ../
    dockerfile: ./build/Dockerfile
  volumes:
    - sockets:/sockets:rw
  depends_on:
    redis:
      condition: service_healthy
  networks:
    - backend
    - payment-processor
  ulimits:
    nproc: 1000000
    nofile:
      soft: 1000000
      hard: 1000000
  deploy:
    resources:
      limits:
        cpus: "0.25"
        memory: "50MB"

services:
  api01:
    <<: *api_template
    hostname: api01
    container_name: rinha-api01
    environment:
      SERVER_SOCKET: /sockets/go.sock.1

  api02:
    <<: *api_template
    hostname: api02
    container_name: rinha-api02
    environment:
      SERVER_SOCKET: /sockets/go.sock.2

  api03:
    <<: *api_template
    hostname: api03
    container_name: rinha-api03
    environment:
      SERVER_SOCKET: /sockets/go.sock.3

  api04:
    <<: *api_template
    hostname: api04
    container_name: rinha-api04
    environment:
      SERVER_SOCKET: /sockets/go.sock.4

  haproxy:
    image: haproxy:latest
    hostname: rinha-haproxy
    container_name: rinha-haproxy
    volumes:
      - ../config/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - sockets:/sockets:rw
    depends_on:
      - api01
      - api02
      - api03
      - api04
    networks:
      - backend
    ports:
      - "9999:9999"
      - "8888:8888"
    deploy:
      resources:
        limits:
          cpus: "0.20"
          memory: "50MB"

  redis:
    image: redis:8-alpine
    hostname: redis
    container_name: rinha-redis
    command: [ "redis-server", "/tmp/docker/redis.conf", "--appendonly", "yes", "--appendfsync", "everysec" ]
    volumes:
      - ../config/redis.conf:/tmp/docker/redis.conf:ro
      - sockets:/sockets:rw
    networks:
      - backend
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      start_period: 1s
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: "0.30"
          memory: "100MB"

volumes:
  prometheus:
  sockets:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=16m,mode=1777

networks:
  backend:
    driver: bridge
  payment-processor:
    external: true
